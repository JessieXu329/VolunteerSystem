<!DOCTYPE html>
<html>
<head>
    <title>报名 - {{ activity.title }}</title>
    <!-- 引入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入 Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <script src="https://unpkg.com/element-plus"></script>
    <!-- 引入字体图标 -->
    <link rel="stylesheet" href="https://unpkg.com/@element-plus/icons-vue/dist/index.css">
    <style>
        body {
            margin: 0;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', '微软雅黑', Arial, sans-serif;
            background-color: #f5f7fa;
        }
        .signup-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px 0 rgba(0,0,0,0.1);
        }
        .page-title {
            text-align: center;
            color: #409EFF;
            margin-bottom: 30px;
        }
        .form-wrapper {
            padding: 20px;
        }
    </style>
</head>
<body>
    {% verbatim %}
    <div id="app">
        <div class="signup-container">
            <h2 class="page-title">活动报名</h2>
            
            <el-form 
                ref="signupForm"
                :model="formData"
                :rules="rules"
                label-width="80px"
                class="form-wrapper">
                
                <el-form-item label="姓名" prop="name">
                    <el-input 
                        v-model="formData.name"
                        placeholder="请输入姓名">
                    </el-input>
                </el-form-item>

                <el-form-item label="学号" prop="student_id">
                    <el-input 
                        v-model="formData.student_id"
                        placeholder="请输入学号">
                    </el-input>
                </el-form-item>

                <el-form-item label="电话" prop="phone">
                    <el-input 
                        v-model="formData.phone"
                        placeholder="请输入电话号码">
                    </el-input>
                </el-form-item>

                <el-form-item label="生日" prop="birthday">
                    <el-date-picker
                        v-model="formData.birthday"
                        type="date"
                        placeholder="选择生日"
                        format="YYYY-MM-DD"
                        value-format="YYYY-MM-DD">
                    </el-date-picker>
                </el-form-item>

                <el-form-item>
                    <el-button type="primary" @click="submitForm">立即报名</el-button>
                    <el-button @click="resetForm">重置</el-button>
                </el-form-item>
            </el-form>
        </div>
    </div>
    {% endverbatim %}

    <script>
        const { createApp, ref } = Vue
        const app = createApp({
            setup() {
                const signupForm = ref(null)
                const formData = ref({
                    name: '',
                    student_id: '',
                    phone: '',
                    birthday: ''
                })

                const rules = {
                    name: [
                        { required: true, message: '请输入姓名', trigger: 'blur' },
                        { min: 2, max: 20, message: '长度在 2 到 20 个字符', trigger: 'blur' }
                    ],
                    student_id: [
                        { required: true, message: '请输入学号', trigger: 'blur' },
                        { pattern: /^\d+$/, message: '学号必须为数字', trigger: 'blur' }
                    ],
                    phone: [
                        { required: true, message: '请输入电话号码', trigger: 'blur' },
                        { pattern: /^1[3-9]\d{9}$/, message: '请输入正确的手机号码', trigger: 'blur' }
                    ],
                    birthday: [
                        { required: true, message: '请选择生日', trigger: 'change' }
                    ]
                }

                const submitForm = async () => {
                    if (!signupForm.value) return
                    
                    await signupForm.value.validate((valid, fields) => {
                        if (valid) {
                            // 获取CSRF Token
                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value
                            
                            // 发送表单数据
                            fetch(window.location.href, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                body: JSON.stringify(formData.value)
                            })
                            .then(response => response.json())
                            .then(data => {
                                ElementPlus.ElMessage.success('报名成功！')
                            })
                            .catch(error => {
                                ElementPlus.ElMessage.error('报名失败，请重试')
                            })
                        }
                    })
                }

                const resetForm = () => {
                    if (signupForm.value) {
                        signupForm.value.resetFields()
                    }
                }

                return {
                    signupForm,
                    formData,
                    rules,
                    submitForm,
                    resetForm
                }
            }
        })

        app.use(ElementPlus)
        app.mount('#app')
    </script>

    {% csrf_token %}
</body>
</html>